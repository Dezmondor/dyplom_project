{% extends "base.html" %}
{% block title %}–ú—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å{% endblock %}
{% block content %}
<div class="container py-4">
  <h2 class="text-center text-warning mb-4">üë§ –í—ñ—Ç–∞—î–º–æ, {{ request.user.first_name }} {{ request.user.last_name }}</h2>

  <!-- üîπ –Ü–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title">–ú–æ—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è</h5>
      <p><strong>Email:</strong> {{ request.user.email }}</p>
      <p><strong>–î–∞—Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –∞–∫–∞—É–Ω—Ç–∞:</strong> {{ request.user.date_joined|date:"d.m.Y" }}</p>
      <a href="{% url 'logout' %}" class="btn btn-outline-danger">–í–∏–π—Ç–∏</a>
    </div>
  </div>

  <!-- üîπ –ß–∞—Ç –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ -->
  <div class="card shadow-sm mb-4">
    <div class="card-body">
      <h5 class="card-title">üí¨ –ß–∞—Ç –∑—ñ —Å–ª—É–∂–±–æ—é –ø—ñ–¥—Ç—Ä–∏–º–∫–∏</h5>
      <div id="chat-box" style="height: 300px; overflow-y: auto; border: 1px solid #ccc; border-radius: 10px; padding: 10px; background: #f9f9f9;">
        {% for msg in chat_messages %}
          <div class="mb-2 {% if msg.is_admin %}text-end{% endif %}">
            <div style="display: inline-block; padding: 8px 12px; border-radius: 10px;
                        background-color: {% if msg.is_admin %}#003366; color: white;{% else %}#e6e6e6;{% endif %}">
              <small>
                {% if msg.is_admin %}<strong>–ê–¥–º—ñ–Ω:</strong>{% else %}<strong>–í–∏:</strong>{% endif %}
              </small>
              <div>{{ msg.message }}</div>
              <small class="text-muted" style="font-size: 0.8em;">{{ msg.created_at|date:"d.m.Y H:i" }}</small>
            </div>
          </div>
        {% empty %}
          <p>–ü–æ–∫–∏ —â–æ –Ω–µ–º–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å.</p>
        {% endfor %}
      </div>

      <script>
document.addEventListener("DOMContentLoaded", () => {
  const chatBox = document.getElementById("chat-box");
  chatBox.scrollTop = chatBox.scrollHeight;
});
</script>



      <form method="post" class="mt-3">
        {% csrf_token %}
        <div class="input-group">
          <input type="text" name="message" class="form-control" placeholder="–ù–∞–ø–∏—à—ñ—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è..." required>
          <button class="btn btn-primary" type="submit">–í—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏</button>
        </div>
      </form>
    </div>
  </div>

<!-- üîπ –ó–∞–º–æ–≤–ª–µ–Ω–Ω—è -->
<div class="card shadow-sm mt-4">
  <div class="card-body">
    {% if request.user.is_staff %}
      <h5 class="card-title">üìã –£—Å—ñ –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤</h5>
    {% else %}
      <h5 class="card-title">üì¶ –ú–æ—ó –∑–∞–º–æ–≤–ª–µ–Ω–Ω—è</h5>
    {% endif %}

    {% if orders %}
      <div class="table-responsive">
        <table class="table table-striped align-middle">
          <thead>
            <tr>
              {% if request.user.is_staff %}
                <th>–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á</th>
              {% endif %}
              <th>–ü–æ—Å–ª—É–≥–∞</th>
              <th>–û–ø–∏—Å</th>
              <th>–î–∞—Ç–∞</th>
              <th>–°—Ç–∞—Ç—É—Å</th>
              <th>–î—ñ—ó</th>
            </tr>
          </thead>
          <tbody>
            {% for o in orders %}
              <tr>
                {% if request.user.is_staff %}
                  <td>{{ o.user.first_name }} {{ o.user.last_name }}<br><small>{{ o.user.email }}</small></td>
                {% endif %}
                <td>{{ o.service.title }}</td>
                <td>{{ o.description|default:"‚Äî" }}</td>
                <td>{{ o.created_at|date:"d.m.Y H:i" }}</td>
                <td>
                  <span class="badge {% if o.status == '–ù–æ–≤–µ' %}bg-warning text-dark{% elif o.status == '–í —Ä–æ–±–æ—Ç—ñ' %}bg-info{% else %}bg-success{% endif %}">
                    {{ o.status }}
                  </span>
                </td>
                <td>
                  {% if request.user.is_staff %}
                    <a href="{% url 'admin_order_detail' o.id %}" class="btn btn-sm btn-outline-primary">
                      –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏
                    </a>
                  {% else %}
                    <a href="{% url 'user_order_detail' o.id %}" class="btn btn-sm btn-outline-secondary">
                      –î–µ—Ç–∞–ª—å–Ω—ñ—à–µ
                    </a>
                  {% endif %}
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    {% else %}
      <p class="mt-3">–ù–µ–º–∞—î –∑–∞–º–æ–≤–ª–µ–Ω—å.</p>
    {% endif %}
  </div>
</div>


{% endblock %}
